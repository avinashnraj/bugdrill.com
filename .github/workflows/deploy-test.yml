name: Quick Deploy Test

on:
  workflow_dispatch:
    inputs:
      docker_tag:
        description: 'Docker tag to deploy (e.g., v0.0.0-123-abc1234 or latest)'
        required: true
        default: 'latest'

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  deploy-test:
    name: Test EC2 Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure SSH
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/bugdrill.pem
          chmod 600 ~/.ssh/bugdrill.pem
          ssh-keyscan -H ec2-54-237-170-112.compute-1.amazonaws.com >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          DOCKER_TAG: ${{ github.event.inputs.docker_tag }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          echo "ðŸš€ Deploying to EC2..."
          echo "Using tag: ${DOCKER_TAG}"
          echo "Username: ${DOCKER_USERNAME}"
          
          ssh -i ~/.ssh/bugdrill.pem ubuntu@ec2-54-237-170-112.compute-1.amazonaws.com bash -s << EOF
            # Update API deployment
            kubectl set image deployment/bugdrill-api \
              bugdrill-api=${DOCKER_USERNAME}/bugdrill-api:${DOCKER_TAG} \
              -n bugdrill
            
            # Update Executor deployment
            kubectl set image deployment/bugdrill-executor \
              bugdrill-executor=${DOCKER_USERNAME}/bugdrill-executor:${DOCKER_TAG} \
              -n bugdrill
            
            # Wait for rollout
            echo "Waiting for API rollout..."
            kubectl rollout status deployment/bugdrill-api -n bugdrill --timeout=300s
            
            echo "Waiting for Executor rollout..."
            kubectl rollout status deployment/bugdrill-executor -n bugdrill --timeout=300s
            
            # Show status
            echo ""
            echo "âœ… Deployment complete!"
            kubectl get pods -n bugdrill -l 'app in (bugdrill-api,bugdrill-executor)'
            
            # Run functional tests
            echo ""
            echo "ðŸ§ª Running functional tests..."
            
            # Delete old test pod if exists
            kubectl delete pod bugdrill-tests -n bugdrill --ignore-not-found=true
            
            # Create test pod
            kubectl run bugdrill-tests --image=${DOCKER_USERNAME}/bugdrill-tests:${DOCKER_TAG} \
              --restart=Never -n bugdrill \
              --env="API_BASE_URL=http://bugdrill-api:8080" \
              --env="EXECUTOR_URL=http://bugdrill-executor:8081"
            
            # Wait for tests to complete
            echo "Waiting for tests to complete..."
            kubectl wait --for=condition=Ready pod/bugdrill-tests -n bugdrill --timeout=30s || true
            kubectl wait --for=jsonpath='{.status.phase}'=Succeeded pod/bugdrill-tests -n bugdrill --timeout=300s || \
            kubectl wait --for=jsonpath='{.status.phase}'=Failed pod/bugdrill-tests -n bugdrill --timeout=10s || true
            
            # Show test results
            echo ""
            echo "ðŸ“Š Test Results:"
            kubectl logs pod/bugdrill-tests -n bugdrill --tail=50 || echo "Could not fetch test logs"
            
            # Check test status
            STATUS=\$(kubectl get pod bugdrill-tests -n bugdrill -o jsonpath='{.status.phase}')
            if [ "\$STATUS" = "Succeeded" ]; then
              echo ""
              echo "âœ… Tests PASSED!"
              exit 0
            else
              echo ""
              echo "âŒ Tests FAILED! (Status: \$STATUS)"
              exit 1
            fi
          EOF

      - name: Summary
        run: |
          echo "âœ… Test deployment complete!"
          echo "Tag deployed: ${{ github.event.inputs.docker_tag }}"
