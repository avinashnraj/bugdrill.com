name: PR Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  GO_VERSION: '1.22'

jobs:
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum
      
      - name: Check Go formatting
        working-directory: backend
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go files not formatted:"
            gofmt -l .
            exit 1
          fi
          echo "✓ All Go files properly formatted"
      
      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0
      
      - name: Run golangci-lint
        working-directory: backend
        run: |
          $(go env GOPATH)/bin/golangci-lint run --timeout=5m
  
  test-changes:
    name: Test Changed Code
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: bugdrill_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum
      
      - name: Install dependencies
        working-directory: backend
        run: |
          go mod download
      
      - name: Run tests with coverage
        working-directory: backend
        env:
          ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: bugdrill_test
          DB_SSL_MODE: disable
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_ACCESS_SECRET: test-secret
          JWT_REFRESH_SECRET: test-refresh-secret
        run: |
          # Apply migrations
          PGPASSWORD=postgres psql -h localhost -U postgres -d bugdrill_test -f migrations/001_init_schema.sql
          PGPASSWORD=postgres psql -h localhost -U postgres -d bugdrill_test -f migrations/seed_base.sql
          
          # Run tests
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out
      
      - name: Check test coverage
        working-directory: backend
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: $COVERAGE%"
          
          # Require at least 50% coverage for PR
          if (( $(echo "$COVERAGE < 50" | bc -l) )); then
            echo "❌ Coverage is below 50% ($COVERAGE%)"
            exit 1
          fi
          
          echo "✓ Coverage meets minimum threshold"
      
      - name: Comment coverage on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage
          message: |
            ## Test Coverage Report
            
            ```
            $(cd backend && go tool cover -func=coverage.out)
            ```

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build API image (no push)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: bugdrill-api:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build Executor image (no push)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/executor/Dockerfile
          push: false
          tags: bugdrill-executor:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  size-check:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check compiled binary size
        working-directory: backend
        run: |
          go build -o bin/bugdrill-api ./cmd/server
          SIZE=$(du -h bin/bugdrill-api | cut -f1)
          echo "Binary size: $SIZE"
          
          # Warn if binary is over 50MB
          SIZE_BYTES=$(stat -f%z bin/bugdrill-api 2>/dev/null || stat -c%s bin/bugdrill-api)
          if [ $SIZE_BYTES -gt 52428800 ]; then
            echo "⚠️ Warning: Binary size exceeds 50MB"
          fi
