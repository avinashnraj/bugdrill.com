name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_TAG: latest

jobs:
  # Job 1: Build AMD64 images and run tests in k3d
  build-and-test:
    name: Build & Test (k3d)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install k3d and kubectl
        run: |
          # Install k3d
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          k3d version
          
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Build AMD64 images
        working-directory: ./backend
        run: |
          echo "Building AMD64 images for k3d..."
          make docker-build-local

      - name: Push images to Docker Hub
        working-directory: ./backend
        run: |
          echo "Pushing AMD64 images to Docker Hub..."
          make docker-push-local

      - name: Create k3d cluster
        working-directory: ./backend
        run: |
          echo "Creating k3d cluster..."
          make k3d-create
          
          # Wait for cluster to be ready
          kubectl wait --for=condition=Ready nodes --all --timeout=120s

      - name: Deploy databases (parallel)
        working-directory: ./backend
        run: |
          echo "Deploying PostgreSQL and Redis..."
          make k3d-deploy-postgres &
          make k3d-deploy-redis &
          wait
          
          # Wait for databases to be ready (Bitnami chart labels)
          kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=postgresql -n bugdrill --timeout=180s
          kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=redis,app.kubernetes.io/component=master -n bugdrill --timeout=180s

      - name: Initialize database
        working-directory: ./backend
        run: |
          echo "Running database migrations..."
          make k3d-init-db
          
          # Wait for migrations to complete
          kubectl wait --for=condition=complete job -l app=bugdrill-init -n bugdrill --timeout=180s || \
          kubectl wait --for=condition=complete job/bugdrill-init-db -n bugdrill --timeout=180s || true

      - name: Deploy services (parallel)
        working-directory: ./backend
        run: |
          echo "Deploying Executor and API..."
          make k3d-deploy-executor &
          make k3d-deploy-api &
          wait
          
          echo "Waiting for services..."
          sleep 10
          kubectl get pods -n bugdrill
          kubectl wait --for=condition=Ready pod -l app=bugdrill-executor -n bugdrill --timeout=180s || true
          kubectl wait --for=condition=Ready pod -l app=bugdrill-api -n bugdrill --timeout=180s || true

      - name: Run integration tests
        working-directory: ./backend
        run: |
          echo "Running integration tests..."
          make k3d-deploy-tests
          
          # Wait for tests to complete
          echo "Waiting for test job to complete..."
          kubectl wait --for=condition=complete job -l app=bugdrill-tests -n bugdrill --timeout=300s || \
          kubectl wait --for=condition=complete job/bugdrill-tests -n bugdrill --timeout=300s

      - name: Extract test results
        if: always()
        working-directory: ./backend
        run: |
          kubectl logs -n bugdrill job/bugdrill-tests --tail=100 || true

      - name: Show cluster status on failure
        if: failure()
        working-directory: ./backend
        run: |
          echo "=== Cluster Status ==="
          make k3d-status || true

      - name: Cleanup
        if: always()
        working-directory: ./backend
        run: |
          k3d cluster delete bugdrill-local || true

  # Job 2: Build production ARM64 images
  build-production:
    name: Build Production (ARM64)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build ARM64 images
        working-directory: ./backend
        run: |
          echo "Building ARM64 images for production..."
          make production-build-push

      - name: Image summary
        run: |
          echo "âœ… Production images built and pushed!"
          echo "Images: ${{ secrets.DOCKER_USERNAME }}/bugdrill-{api,executor,tests}:latest"
          echo "Architecture: linux/arm64"
          echo "Ready for EC2 deployment"
