name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_TAG: latest

jobs:
  # Job 1: Build AMD64 images and run tests in k3d
  build-and-test:
    name: Build & Test (k3d)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start k3d runner container
        working-directory: ./backend
        run: |
          docker compose -f docker-compose.k3d.yml up -d
          
          # Wait for container to be running
          echo "Waiting for container to start..."
          sleep 5
          
          # Check if container is running
          if ! docker ps | grep -q bugdrill-k3d-runner; then
            echo "Container failed to start. Checking logs..."
            docker logs bugdrill-k3d-runner || true
            docker compose -f docker-compose.k3d.yml logs
            exit 1
          fi
          
          # Wait for Docker-in-Docker daemon to be ready
          echo "Waiting for Docker daemon to initialize..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if docker exec bugdrill-k3d-runner docker info >/dev/null 2>&1; then
              echo "✓ Docker daemon is ready"
              docker exec bugdrill-k3d-runner docker info
              break
            fi
            
            attempt=$((attempt + 1))
            echo "Waiting for Docker daemon... ($attempt/$max_attempts)"
            sleep 2
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "✗ Docker daemon failed to start"
            docker logs bugdrill-k3d-runner
            exit 1
          fi

      - name: Build AMD64 images
        working-directory: ./backend
        run: |
          echo "Building AMD64 images for k3d..."
          docker exec bugdrill-k3d-runner bash -c "cd /workspace && make docker-build-local"

      - name: Create k3d cluster
        working-directory: ./backend
        run: |
          echo "Creating k3d cluster..."
          docker exec bugdrill-k3d-runner bash -c "cd /workspace && make k3d-create"

      - name: Deploy databases (parallel)
        working-directory: ./backend
        run: |
          echo "Deploying PostgreSQL and Redis in parallel..."
          docker exec bugdrill-k3d-runner bash -c "cd /workspace && make k3d-deploy-postgres & make k3d-deploy-redis & wait"

      - name: Initialize database
        working-directory: ./backend
        run: |
          echo "Running database migrations..."
          docker exec bugdrill-k3d-runner bash -c "cd /workspace && make k3d-init-db"

      - name: Deploy services (parallel)
        working-directory: ./backend
        run: |
          echo "Deploying Executor and API in parallel..."
          docker exec bugdrill-k3d-runner bash -c "cd /workspace && make k3d-deploy-executor & make k3d-deploy-api & wait"

      - name: Run integration tests
        working-directory: ./backend
        run: |
          echo "Running integration tests..."
          docker exec bugdrill-k3d-runner bash -c "cd /workspace && make k3d-deploy-tests"

      - name: Extract test results
        if: always()
        working-directory: ./backend
        run: |
          docker exec bugdrill-k3d-runner bash -c "cd /workspace && kubectl logs -n bugdrill job/bugdrill-tests --tail=100" || true

      - name: Show cluster status on failure
        if: failure()
        working-directory: ./backend
        run: |
          echo "=== Cluster Status ==="
          docker exec bugdrill-k3d-runner bash -c "cd /workspace && make k3d-status" || true

      - name: Cleanup
        if: always()
        working-directory: ./backend
        run: |
          docker compose -f docker-compose.k3d.yml down -v

  # Job 2: Build production ARM64 images
  build-production:
    name: Build Production (ARM64)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build ARM64 images
        working-directory: ./backend
        run: |
          echo "Building ARM64 images for production..."
          make production-build-push

      - name: Image summary
        run: |
          echo "✅ Production images built and pushed!"
          echo "Images: ${{ secrets.DOCKER_USERNAME }}/bugdrill-{api,executor,tests}:latest"
          echo "Architecture: linux/arm64"
          echo "Ready for EC2 deployment"
